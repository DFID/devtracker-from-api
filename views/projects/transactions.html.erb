<!--
title: Development Tracker
 -->

<%= erb :'partials/_projects-header', :locals => { :project => project, :active => "transactions"} %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <h2 class="govuk-heading-m">Transactions</h2>

    <div id="waiting" class="twelve columns" style="display: none;"><p style="text-align: center; padding: 15px;"><strong class="govuk-tag govuk-tag--yellow">Loading Data.. Please wait..</strong></p></div>

    <div class="govuk-accordion" data-module="govuk-accordion" id="accordion-default">
      <%# ------------------------------------------------------------------------ %>
      <%#                   I N C O M I N G   F U N D S   T A B L E                %>
      <%# ------------------------------------------------------------------------ %>  
      <div class="govuk-accordion__section app-display-none" id="incoming_funds_container">
          <div class="govuk-accordion__section-header">
              <h2 class="govuk-accordion__section-heading">
                  <span class="govuk-accordion__section-button" id="accordion-commitments">
                      Incoming Funds
                  </span>
              </h2>
              <div class="govuk-accordion__section-summary govuk-body" id="accordion-with-summary-sections-summary-1">
                  Funds that originate from a source other than the donor(s) reported in the activity.
              </div>
          </div>
          <div id="incoming-funds-content" class="govuk-accordion__section-content" aria-labelledby="incoming-funds-content">
            <div class="app-flex-container govuk-!-margin-bottom-4">
              <div class="govuk-heading-l govuk-!-padding-top-2">
                <span id="totalIncomingFundsValue">Calculating..</span>
                <span class="app-grey-text govuk-!-display-block govuk-!-font-size-14">Funds received from an external funding source.</span>
              </div>
              <div class="app-flex-container--item-right">
                  <p class="govuk-!-font-size-16 govuk-!-margin-top-0 govuk-!-margin-bottom-0">Download data</p>
                  <a href="/downloadCSV/<%= project['iati_identifier']%>/1" class="api-link button"><strong class="govuk-tag govuk-tag--blue govuk-!-margin-top-1">CSV</strong></a>
              </div>
            </div>
            <table id="incomingFunds" class="govuk-table transactions-tablev2 display" style="width:100%; display: none">
              <thead>
                <tr>
                  <th>Activity Description</th>
                  <th>Provider</th>
                  <th>Date</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>    
            <div class="govuk-!-margin-top-4" id="loanRepayments_more">
              <a href="#" class="govuk-body govuk-link" data-module="govuk-button">
                Load more
              </a>
              <input id="loanRepayments_more_data" type="hidden" value="1" />
            </div>                      
          </div>          
      </div>

      <%# ------------------------------------------------------------------------ %>
      <%#                   C O M M I T M E N T S   T A B L E                      %>
      <%# ------------------------------------------------------------------------ %>
      <div class="govuk-accordion__section app-display-none" id="commitments_container">
          <div class="govuk-accordion__section-header">
              <h2 class="govuk-accordion__section-heading">
                  <span class="govuk-accordion__section-button" id="accordion-commitments">
                       Commitments
                  </span>
              </h2>
              <div class="govuk-accordion__section-summary govuk-body" id="accordion-with-summary-sections-summary-1">
                  A firm obligation to provide resources of a specified amount.
              </div>
          </div>
          <div id="incoming-funds-content" class="govuk-accordion__section-content" aria-labelledby="incoming-funds-content">
            <div class="app-flex-container govuk-!-margin-bottom-4">
              <div class="govuk-heading-l govuk-!-margin-bottom-0 govuk-!-padding-top-2">
                <span id="totalCommitmentValue">Calculating..</span>
              </div>
              <div class="app-flex-container--item-right">
                  <p class="govuk-!-font-size-16 govuk-!-margin-top-0 govuk-!-margin-bottom-0">Download data</p>
                  <a href="/downloadCSV/<%= project['iati_identifier']%>/2" class="api-link button"><strong class="govuk-tag govuk-tag--blue govuk-!-margin-top-1">CSV</strong></a>
              </div>
            </div>
            <table id="commitments" class="govuk-table transactions-tablev2 display" style="width:100%; display: none">
              <thead>
                <tr>
                  <th>Receiver Organisation</th>
                  <th>Organisation Type</th>
                  <th>IATI Activity ID</th>
                  <th>Date</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>    
            <div class="govuk-!-margin-top-4" id="commitments_more">
              <a href="#" class="govuk-body govuk-link" data-module="govuk-button">
                Load more
              </a>
              <input id="commitments_more_data" type="hidden" value="1" />
            </div>                      
          </div>          
      </div> 

      <%# ------------------------------------------------------------------------ %>
      <%#                   D I S B U R S E M E N T S   T A B L E                  %>                   
      <%# ------------------------------------------------------------------------ %>      
      <div class="govuk-accordion__section app-display-none" id="disbursements_container">
          <div class="govuk-accordion__section-header">
              <h2 class="govuk-accordion__section-heading">
                  <span class="govuk-accordion__section-button" id="accordion-commitments">
                       Disbursements
                  </span>
              </h2>
              <div class="govuk-accordion__section-summary govuk-body" id="accordion-with-summary-sections-summary-1">
                  The amount placed at the disposal of a recipient country or agency.
              </div>
          </div>
          <div id="incoming-funds-content" class="govuk-accordion__section-content" aria-labelledby="incoming-funds-content">
            <div class="app-flex-container govuk-!-margin-bottom-4">
              <div class="govuk-heading-l govuk-!-margin-bottom-0 govuk-!-padding-top-2">
                <span id="totalDisbursementsValue">Calculating..</span>
              </div>
              <div class="app-flex-container--item-right">
                  <p class="govuk-!-font-size-16 govuk-!-margin-top-0 govuk-!-margin-bottom-0">Download data</p>
                  <a href="/downloadCSV/<%= project['iati_identifier']%>/3" class="api-link button"><strong class="govuk-tag govuk-tag--blue govuk-!-margin-top-1">CSV</strong></a>
              </div>
            </div>
            <table id="disbursements" class="govuk-table transactions-tablev2 display" style="width:100%; display: none">
              <thead>
                <tr>
                  <th>Receiver Organisation</th>
                  <th>Organisation Type</th>
                  <th>IATI Activity ID</th>
                  <th>Date</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>    
            <div class="govuk-!-margin-top-4" id="disbursements_more">
              <a href="#" class="govuk-body govuk-link" data-module="govuk-button">
                Load more
              </a>
              <input id="disbursements_more_data" type="hidden" value="1" />
            </div>                      
          </div>          
      </div>    
                    
      <%# ------------------------------------------------------------------------ %>
      <%#                   E X P E N D I T U R E   T A B L E                      %>
      <%# ------------------------------------------------------------------------ %>
      <div class="govuk-accordion__section app-display-none" id="expenditures_container">
          <div class="govuk-accordion__section-header">
              <h2 class="govuk-accordion__section-heading">
                  <span class="govuk-accordion__section-button" id="accordion-commitments">
                       Expenditure
                  </span>
              </h2>
              <div class="govuk-accordion__section-summary govuk-body" id="accordion-with-summary-sections-summary-1">
                  Funds spent on goods and services.
              </div>
          </div>
          <div id="incoming-funds-content" class="govuk-accordion__section-content" aria-labelledby="incoming-funds-content">
            <div class="app-flex-container govuk-!-margin-bottom-4">
              <div class="govuk-heading-l govuk-!-margin-bottom-0 govuk-!-padding-top-2">
                <span id="totalExpenditureValue">Calculating..</span>
              </div>
              <div class="app-flex-container--item-right">
                  <p class="govuk-!-font-size-16 govuk-!-margin-top-0 govuk-!-margin-bottom-0">Download data</p>
                  <a href="/downloadCSV/<%= project['iati_identifier']%>/4" class="api-link button"><strong class="govuk-tag govuk-tag--blue govuk-!-margin-top-1">CSV</strong></a>
              </div>
            </div>
            <table id="expenditures" class="govuk-table transactions-tablev2 display" style="width:100%; display: none">
              <thead>
                <tr>
                  <th>Activity Description</th>
                  <th>Receiver Organisation</th>
                  <th>IATI Activity ID</th>
                  <th>Date</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>    
            <div class="govuk-!-margin-top-4" id="expenditures_more">
              <a href="#" class="govuk-body govuk-link" data-module="govuk-button">
                Load more
              </a>
              <input id="expenditures_more_data" type="hidden" value="1" />
            </div>                      
          </div>          
      </div>  

      <%# ------------------------------------------------------------------------------------- %>
      <%#                   I N T E R E S T  R E P A Y M E N T   T A B L E                      %>
      <%# ------------------------------------------------------------------------------------- %>                      
      <div class="govuk-accordion__section app-display-none" id="interestRepayments_container">
          <div class="govuk-accordion__section-header">
              <h2 class="govuk-accordion__section-heading">
                  <span class="govuk-accordion__section-button" id="accordion-commitments">
                       Interest Repayment
                  </span>
              </h2>
              <div class="govuk-accordion__section-summary govuk-body" id="accordion-with-summary-sections-summary-1">
                  Amount of interest paid on a loan or line of credit, including fees
              </div>
          </div>
          <div id="incoming-funds-content" class="govuk-accordion__section-content" aria-labelledby="incoming-funds-content">
            <div class="app-flex-container govuk-!-margin-bottom-4">
              <div class="govuk-heading-l govuk-!-margin-bottom-0 govuk-!-padding-top-2">
                <span id="totalInterestRepaymentsValue">Calculating..</span>
              </div>
              <div class="app-flex-container--item-right">
                  <p class="govuk-!-font-size-16 govuk-!-margin-top-0 govuk-!-margin-bottom-0">Download data</p>
                  <a href="/downloadCSV/<%= project['iati_identifier']%>/5" class="api-link button"><strong class="govuk-tag govuk-tag--blue govuk-!-margin-top-1">CSV</strong></a>
              </div>
            </div>
            <table id="interestRepayments" class="govuk-table transactions-tablev2 display" style="width:100%; display: none">
              <thead>
                <tr>
                  <th>Activity Description</th>
                  <th>Receiver Organisation</th>
                  <th>IATI Activity ID</th>
                  <th>Date</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>    
            <div class="govuk-!-margin-top-4" id="interestRepayments_more">
              <a href="#" class="govuk-body govuk-link" data-module="govuk-button">
                Load more
              </a>
              <input id="interestRepayments_more_data" type="hidden" value="1" />
            </div>                      
          </div>          
      </div>

      <%# ------------------------------------------------------------------------------------- %>
      <%#                   L O A N  R E P A Y M E N T   T A B L E                              %>
      <%# ------------------------------------------------------------------------------------- %>
      <div class="govuk-accordion__section app-display-none" id="loanRepayments_container">
          <div class="govuk-accordion__section-header">
              <h2 class="govuk-accordion__section-heading">
                  <span class="govuk-accordion__section-button" id="accordion-commitments">
                       Loan Repayment
                  </span>
              </h2>
              <div class="govuk-accordion__section-summary govuk-body" id="accordion-with-summary-sections-summary-1">
                  The actual amount of principal (amortisation) repaid, including any arrears
              </div>
          </div>
          <div id="incoming-funds-content" class="govuk-accordion__section-content" aria-labelledby="incoming-funds-content">
            <div class="app-flex-container govuk-!-margin-bottom-4">
              <div class="govuk-heading-l govuk-!-margin-bottom-0 govuk-!-padding-top-2">
                <span id="totalLoanRepaymentsValue">Calculating..</span>
              </div>
              <div class="app-flex-container--item-right">
                  <p class="govuk-!-font-size-16 govuk-!-margin-top-0 govuk-!-margin-bottom-0">Download data</p>
                  <a href="/downloadCSV/<%= project['iati_identifier']%>/6" class="api-link button"><strong class="govuk-tag govuk-tag--blue govuk-!-margin-top-1">CSV</strong></a>
              </div>
            </div>
            <table id="loanRepayments" class="govuk-table transactions-tablev2 display" style="width:100%; display: none">
              <thead>
                <tr>
                  <th>Activity Description</th>
                  <th>Receiver Organisation</th>
                  <th>IATI Activity ID</th>
                  <th>Date</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>    
            <div class="govuk-!-margin-top-4" id="loanRepayments_more">
              <a href="#" class="govuk-body govuk-link" data-module="govuk-button">
                Load more
              </a>
              <input id="loanRepayments_more_data" type="hidden" value="1" />
            </div>                      
          </div>          
      </div>

      <%# ------------------------------------------------------------------------------------- %>
      <%#                   P U R C H A S E  O F  E Q U I T Y    T A B L E                      %>
      <%# ------------------------------------------------------------------------------------- %>
      <div class="govuk-accordion__section app-display-none" id="purchaseEquities_container">
          <div class="govuk-accordion__section-header">
              <h2 class="govuk-accordion__section-heading">
                  <span class="govuk-accordion__section-button" id="accordion-commitments">
                       Purchase of Equity
                  </span>
              </h2>
              <div class="govuk-accordion__section-summary govuk-body" id="accordion-with-summary-sections-summary-1">
                  Outgoing funds to purchase equity
              </div>
          </div>
          <div id="incoming-funds-content" class="govuk-accordion__section-content" aria-labelledby="incoming-funds-content">
            <div class="app-flex-container govuk-!-margin-bottom-4">
              <div class="govuk-heading-l govuk-!-margin-bottom-0 govuk-!-padding-top-2">
                <span id="totalPurchaseEquitiesValue">Calculating..</span>
              </div>
              <div class="app-flex-container--item-right">
                  <p class="govuk-!-font-size-16 govuk-!-margin-top-0 govuk-!-margin-bottom-0">Download data</p>
                  <a href="/downloadCSV/<%= project['iati_identifier']%>/8" class="api-link button"><strong class="govuk-tag govuk-tag--blue govuk-!-margin-top-1">CSV</strong></a>
              </div>
            </div>
            <table id="purchaseEquities" class="govuk-table transactions-tablev2 display" style="width:100%; display: none">
              <thead>
                <tr>
                  <th>Activity Description</th>
                  <th>Receiver Organisation</th>
                  <th>IATI Activity ID</th>
                  <th>Date</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>    
            <div class="govuk-!-margin-top-4" id="purchaseEquities_more">
              <a href="#" class="govuk-body govuk-link" data-module="govuk-button">
                Load more
              </a>
              <input id="purchaseEquities_more_data" type="hidden" value="1" />
            </div>                      
          </div>          
      </div>
    </div>
  </div>
</div>


<script src="/javascripts/jquery-3.3.1.js" type="text/javascript"></script>
<script src="/javascripts/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="/javascripts/dataTables.buttons.min.js" type="text/javascript"></script>
<script src="/javascripts/buttons.flash.min.js" type="text/javascript"></script>
<script src="/javascripts/buttons.html5.min.js" type="text/javascript"></script>
<script src="/javascripts/buttons.print.min.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="/stylesheets/jquery.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="/stylesheets/buttons.dataTables.min.css">
<script src="/javascripts/dinero.min.js" type="text/javascript"></script>
<script type="text/javascript">
  var jq3 = jQuery.noConflict(true);
  jq3(document).ready(function() {
    // Handle partners tab button
    $('#waiting').show();
    jq3.get('/get-funding-projects/<%= project["iati_identifier"]%>')
    .done(function(response){
      if(response.output > 0) {
        $('.partner-tab').show();
      }
      else {
        jq3.get('/get-funded-projects/<%= project["iati_identifier"]%>')
        .done(function(res){
          if(res.output > 0) {
            $('.partner-tab').show();
          }
        })
      }
    });
    let dollarUSLocale = Intl.NumberFormat('en-US');
    //console.log(orgTypes.data.find(element => element.code == 10).name)
    var projectCurrency = "<%= begin project['default-currency'] rescue 'GBP' end%>" ;
    function convertCurrency(value) {
      var tempData = {};
      tempData['precPoint'] = 0;
      tempData['amount'] = value;
      if(tempData['amount'].toString().includes('.')) {
        tempData['precPoint'] = tempData['amount'].toString().length - (tempData['amount'].toString().indexOf('.')+1);
        tempData['amount'] = parseInt(tempData['amount'].toString().replace('.', ''));
      }
      return tempData;
    }
    const months = [
      'Jan',
      'Feb',
      'Mar',
      'Apr',
      'May',
      'Jun',
      'Jul',
      'Aug',
      'Sep',
      'Oct',
      'Nov',
      'Dec'
    ];
    // The following is for commitments
    function a7(nextPage){
      return jq3.post('/transaction-details-pagev2', {
        data: {
          'projectID': "<%= project['iati_identifier'] %>",
          'transactionType': 2,
          'nextPage': nextPage
        }
      })
      .done(function(response){
        console.log(response)
        res = response.output['transactions'];
        if (res.length > 0) {
          if(!response.output['hasNext']){
            $('#commitments_more').hide();
          }
          var total_commitments = 0.00;
          var tabCommitments = jq3('#commitments').DataTable({
            retrieve: true,
            "info": false,
            "paging": false,
            "searching": false,
            dom: 'Bfrtip',
            buttons: [
              'csvHtml5'
            ],
            initComplete: function(){
              var $buttons = jq3('.dt-buttons').hide();
              $buttons.parent().parent().children('.downloadInCSV').click(function(){
                $buttons.find('.button-csv').click();
              });
            }
          });
          jq3('#commitments_container').show();
          jq3('#commitments').show();
          jq3.each(res, function(i, data){
            total_commitments = total_commitments + parseFloat(data.valueNoCurrency);
            var receiver_org = '';
            try {
              receiver_org = data.receiver_org_title;
            }
            catch {
              receiver_org = 'N/A';
            }
            var receiver_org_type = data.receiver_org_type;
            var transaction_date = new Date(data.transaction_date);
            var final_date = ('0' + transaction_date.getDate()).slice(-2).toString() + ' ' + months[transaction_date.getMonth()] + ' ' + transaction_date.getFullYear().toString();
            var amount = data.value;
            tabCommitments.row.add([receiver_org, receiver_org_type, data.iati_identifier, final_date, amount]);
            tabCommitments.draw();
          });
        }
      });
    }
    // Incoming Funds logic starts here
    
    function a6(nextPage) {
      return jq3.post('/transaction-details-pagev2', {
        data: {
          'projectID': "<%= project['iati_identifier'] %>",
          'transactionType': 1,
          'nextPage': nextPage
        }
      })
      .done(function(response){
        console.log('incoming funds');
        console.log(response);
        res = response.output['transactions'];
        if(res.length > 0){
          if(!response.output['hasNext']){
           // $('#incomingFunds_more').hide();
          }
          var total_incoming_funds = 0.00;
          var tabincomingFunds = jq3('#incomingFunds').DataTable({
            retrieve: true,
            "info": false,
            "paging": false,
            "searching": false,
            dom: 'Bfrtip',
            buttons: [
              'csvHtml5'
            ],
            initComplete: function(){
              var $buttons = jq3('.dt-buttons').hide();
              $buttons.parent().parent().children('.downloadInCSV').click(function(){
                $buttons.find('.button-csv').click();
              });
            }
          });
          jq3('#incoming_funds_container').show();
          jq3('#incomingFunds').show();
          jq3.each(res, function(i, data){
            total_incoming_funds = total_incoming_funds + parseFloat(data.valueNoCurrency);
            var activity_description = '';
            var provider_org = '';
            var provider_activity_id = '';
            try {
              provider_activity_id = ' (' + data.provider_activity_id + ')';
            }
            catch {
              provider_activity_id = 'N/A';
            }
            try {
              activity_description = data.description;
            }
            catch {
              activity_description = '';
            }
            try {
              provider_org = data.provider_org + provider_activity_id;
            }
            catch {
              provider_org = 'N/A';
            }
            var transaction_date = new Date(data.transaction_date);
            var final_date = ('0' + transaction_date.getDate()).slice(-2).toString() + ' ' + months[transaction_date.getMonth()] + ' ' + transaction_date.getFullYear().toString();
            var amount = data.value;
            tabincomingFunds.row.add([activity_description, provider_org, final_date, amount]);
            tabincomingFunds.draw();
          });
        }
      });
    }
    // Incoming Funds logic ends here
    
    // Disbursment logic starts here
    function a5(nextPage){
      return jq3.post('/transaction-details-pagev2', {
        data: {
          'projectID': "<%= project['iati_identifier'] %>",
          'transactionType': 3,
          'nextPage': nextPage
        }
      })
      .done(function(response){
        res = response.output['transactions'];
        if (res.length > 0) {
          if(!response.output['hasNext']){
            $('#disbursements_more').hide();
          }
          var total_disbursments = 0.00;
          var tabDisbursments = jq3('#disbursements').DataTable({
            retrieve: true,
            "info": false,
            "paging": false,
            "searching": false,
            dom: 'Bfrtip',
            buttons: [
              'csvHtml5'
            ],
            initComplete: function(){
              var $buttons = jq3('.dt-buttons').hide();
              $buttons.parent().parent().children('.downloadInCSV').click(function(){
                $buttons.find('.button-csv').click();
              });
            }
          });
          jq3('#disbursements_container').show();
          jq3('#disbursements').show();
          jq3.each(res, function(i, data){
            total_disbursments = total_disbursments + parseFloat(data.valueNoCurrency);
            var receiver_org = '';
            try {
              receiver_org = data.receiver_org_title;
            }
            catch {
              receiver_org = 'N/A';
            }
            var receiver_org_type = data.receiver_org_type;
            var transaction_date = new Date(data.transaction_date);
            var final_date = ('0' + transaction_date.getDate()).slice(-2).toString() + ' ' + months[transaction_date.getMonth()] + ' ' + transaction_date.getFullYear().toString();
            var amount = data.value;
            tabDisbursments.row.add([receiver_org, receiver_org_type, data.iati_identifier, final_date, amount]);
            tabDisbursments.draw();
          });
        }
      });
    }
    // Disbursment logic ends here

    // Expenditure logic starts here
    
    function a4(nextPage) {
      return jq3.post('/transaction-details-pagev2', {
        data: {
          'projectID': "<%= project['iati_identifier'] %>",
          'transactionType': 4,
          'nextPage': nextPage
        }
      })
      .done(function(response){
        res = response.output['transactions'];
        if (res.length > 0) {
          if(!response.output['hasNext']){
            $('#expenditures_more').hide();
          }
          var total_expenditures = 0.00;
          var tabExpenditures = jq3('#expenditures').DataTable({
            retrieve: true,
            "info": false,
            "paging": false,
            "searching": false,
            //"ordering": false,
            dom: 'Bfrtip',
            buttons: [
              'csvHtml5'
            ],
            initComplete: function(){
              var $buttons = jq3('.dt-buttons').hide();
              $buttons.parent().parent().children('.downloadInCSV').click(function(){
                $buttons.find('.button-csv').click();
              });
            }
          });
          jq3('#expenditures_container').show();
          jq3('#expenditures').show();
          jq3.each(res, function(i, data){
            total_expenditures = total_expenditures + parseFloat(data.valueNoCurrency);
            var receiver_org = '';
            var activity_description = '';
            try {
              receiver_org = data.receiver_org_title;
            }
            catch {
              receiver_org = 'N/A';
            }
            try {
              activity_description = data.description;
            }
            catch {
              activity_description = 'N/A';
            }
            var transaction_date = new Date(data.transaction_date);
            var final_date = ('0' + transaction_date.getDate()).slice(-2).toString() + ' ' + months[transaction_date.getMonth()] + ' ' + transaction_date.getFullYear().toString();
            var amount = data.value;
            tabExpenditures.row.add([activity_description, receiver_org, data.iati_identifier, final_date, amount]);
            tabExpenditures.draw();
          });
        }
      });
    }
    // Expenditure logic ends here

    //Interest Repayment logic starts here
    function a3(nextPage) {
      return jq3.post('/transaction-details-pagev2', {
        data: {
          'projectID': "<%= project['iati_identifier'] %>",
          'transactionType': 5,
          'nextPage': nextPage
        }
      })
      .done(function(response){
        res = response.output['transactions'];
        if (res.length > 0) {
          if(!response.output['hasNext']){
            $('#interestRepayments_more').hide();
          }
          var total_interestRepayments = 0.00;
          var tabInterestRepayments = jq3('#interestRepayments').DataTable({
            retrieve: true,
            "info": false,
            "paging": false,
            "searching": false,
            dom: 'Bfrtip',
            buttons: [
              'csvHtml5'
            ],
            initComplete: function(){
              var $buttons = jq3('.dt-buttons').hide();
              $buttons.parent().parent().children('.downloadInCSV').click(function(){
                $buttons.find('.button-csv').click();
              });
            }
          });
          jq3('#interestRepayments_container').show();
          jq3('#interestRepayments').show();
          jq3.each(res, function(i, data){
            total_interestRepayments = total_interestRepayments + parseFloat(data.valueNoCurrency);
            var receiver_org = '';
            var activity_description = '';
            var receiver_activity_id = '';
            try {
              receiver_activity_id = data.receiver_activity_id;
            }
            catch {
              receiver_activity_id = 'N/A';
            }
            try {
              receiver_org = data.receiver_org_title;
            }
            catch {
              receiver_org = 'N/A';
            }
            try {
              activity_description = data.description;
            }
            catch {
              activity_description = 'N/A';
            }
            var transaction_date = new Date(data.transaction_date);
            var final_date = ('0' + transaction_date.getDate()).slice(-2).toString() + ' ' + months[transaction_date.getMonth()] + ' ' + transaction_date.getFullYear().toString();
            var amount = data.value;
            tabInterestRepayments.row.add([activity_description, receiver_org, receiver_activity_id, final_date, amount]);
            tabInterestRepayments.draw();
          });
        }
      });
    }
    //Interest Repayment logic ends here

    //Loan Repayment logic starts here
    
    function a2(nextPage) {
      return jq3.post('/transaction-details-pagev2', {
        data: {
          'projectID': "<%= project['iati_identifier'] %>",
          'transactionType': 6,
          'nextPage': nextPage
        }
      })
      .done(function(response){
        res = response.output['transactions'];
        if (res.length > 0) {
          if(!response.output['hasNext']){
            $('#loanRepayments_more').hide();
          }
          var total_interestRepayments = 0.00;
          var tabInterestRepayments = jq3('#loanRepayments').DataTable({
            retrieve: true,
            "info": false,
            "paging": false,
            "searching": false,
            dom: 'Bfrtip',
            buttons: [
              'csvHtml5'
            ],
            initComplete: function(){
              var $buttons = jq3('.dt-buttons').hide();
              $buttons.parent().parent().children('.downloadInCSV').click(function(){
                $buttons.find('.button-csv').click();
              });
            }
          });
          jq3('#loanRepayments_container').show();
          jq3('#loanRepayments').show();
          jq3.each(res, function(i, data){
            total_interestRepayments = total_interestRepayments + parseFloat(data.valueNoCurrency);
            var receiver_org = '';
            var activity_description = '';
            var receiver_activity_id = '';
            try {
              receiver_activity_id = data.receiver_activity_id;
            }
            catch {
              receiver_activity_id = 'N/A';
            }
            try {
              receiver_org = data.receiver_org_title;
              if (receiver_org == 'Journal Transaction') {
                receiver_activity_id = data.iati_identifier;
              }
            }
            catch {
              receiver_org = 'N/A';
            }
            try {
              activity_description = data.description;
            }
            catch {
              activity_description = 'N/A';
            }
            var transaction_date = new Date(data.transaction_date);
            var final_date = ('0' + transaction_date.getDate()).slice(-2).toString() + ' ' + months[transaction_date.getMonth()] + ' ' + transaction_date.getFullYear().toString();
            var amount = data.value;
            tabInterestRepayments.row.add([activity_description, receiver_org, receiver_activity_id, final_date, amount]);
            tabInterestRepayments.draw();
          });
        }
      });
    }
    // Loan Repayment logic ends here

    // Purchase of equities
    function a1(nextPage) {
      return jq3.post('/transaction-details-pagev2', {
        data: {
          'projectID': "<%= project['iati_identifier'] %>",
          'transactionType': 8,
          'nextPage': nextPage
        }
      })
      .done(function(response){
        res = response.output['transactions'];
        if (res.length > 0) {
          if(!response.output['hasNext']){
            $('#purchaseEquities_more').hide();
          }
          var total_interestRepayments = 0.00;
          var tabInterestRepayments = jq3('#purchaseEquities').DataTable({
            retrieve: true,
            "info": false,
            "paging": false,
            "searching": false,
            dom: 'Bfrtip',
            buttons: [
              'csvHtml5'
            ],
            initComplete: function(){
              var $buttons = jq3('.dt-buttons').hide();
              $buttons.parent().parent().children('.downloadInCSV').click(function(){
                $buttons.find('.button-csv').click();
              });
            }
          });
          jq3('#purchaseEquities_container').show();
          jq3('#purchaseEquities').show();
          jq3.each(res, function(i, data){
            total_interestRepayments = total_interestRepayments + parseFloat(data.valueNoCurrency);
            var receiver_org = '';
            var activity_description = '';
            var receiver_activity_id = '';
            try {
              receiver_activity_id = data.receiver_activity_id;
            }
            catch {
              receiver_activity_id = 'N/A';
            }
            try {
              receiver_org = data.receiver_org_title;
              if (receiver_org == 'Journal Transaction') {
                receiver_activity_id = data.iati_identifier;
              }
            }
            catch {
              receiver_org = 'N/A';
            }
            try {
              activity_description = data.description;
            }
            catch {
              activity_description = 'N/A';
            }
            var transaction_date = new Date(data.transaction_date);
            var final_date = ('0' + transaction_date.getDate()).slice(-2).toString() + ' ' + months[transaction_date.getMonth()] + ' ' + transaction_date.getFullYear().toString();
            var amount = data.value;
            tabInterestRepayments.row.add([activity_description, receiver_org, receiver_activity_id, final_date, amount]);
            tabInterestRepayments.draw();
          });
        }
      });
    }
    // Purchase of equity logic ends here
    function allDone() {
      $('#waiting').hide();
    }
    function someFailed() {
      console.log('Some failed!');
    }
    $.when(a7(1), a6(1), a5(1), a4(1), a3(1), a2(1), a1(1)).then(allDone, someFailed);
    $('#expenditures_more').click(function(){
      var page = parseInt($('#expenditures_more_data').val()) + 1;
      $('#expenditures_more_data').val(page);
      a4(page);
    });
    $('#purchaseEquities_more').click(function(){
      var page = parseInt($('#purchaseEquities_more_data').val()) + 1;
      $('#purchaseEquities_more_data').val(page);
      a1(page);
    });
    $('#loanRepayments_more').click(function(){
      var page = parseInt($('#loanRepayments_more_data').val()) + 1;
      $('#loanRepayments_more_data').val(page);
      a2(page);
    });
    $('#interestRepayments_more').click(function(){
      var page = parseInt($('#interestRepayments_more_data').val()) + 1;
      $('#interestRepayments_more_data').val(page);
      a3(page);
    });
    $('#disbursements_more').click(function(){
      var page = parseInt($('#disbursements_more_data').val()) + 1;
      $('#disbursements_more_data').val(page);
      a5(page);
    });
    $('#incomingFunds_more').click(function(){
      var page = parseInt($('#incomingFunds_more_data').val()) + 1;
      $('#incomingFunds_more_data').val(page);
      a6(page);
    });
    $('#commitments_more').click(function(){
      var page = parseInt($('#commitments_more_data').val()) + 1;
      $('#commitments_more_data').val(page);
      a7(page);
    });
    jq3.post('/transaction-total', {
      data: {
        project: "<%= project['iati_identifier']%>",
        transactionType: 2,
        currency: "<%= begin project['default_currency']['code'] rescue 'GBP' end%>"
      }
    })
    .done(function(res){
      jq3('#totalCommitmentValue').html(res.output);
    });
    jq3.post('/transaction-total', {
      data: {
        project: "<%= project['iati_identifier']%>",
        transactionType: 1,
        currency: "<%= begin project['default_currency']['code'] rescue 'GBP' end%>"
      }
    })
    .done(function(res){
      jq3('#totalIncomingFundsValue').html(res.output);
    });
    jq3.post('/transaction-total', {
      data: {
        project: "<%= project['iati_identifier']%>",
        transactionType: 3,
        currency: "<%= begin project['default_currency']['code'] rescue 'GBP' end%>"
      }
    })
    .done(function(res){
      jq3('#totalDisbursementsValue').html(res.output);
    });
    jq3.post('/transaction-total', {
      data: {
        project: "<%= project['iati_identifier']%>",
        transactionType: 5,
        currency: "<%= begin project['default_currency']['code'] rescue 'GBP' end%>"
      }
    })
    .done(function(res){
      jq3('#totalInterestRepaymentsValue').html(res.output);
    });
    jq3.post('/transaction-total', {
      data: {
        project: "<%= project['iati_identifier'] %>",
        transactionType: 8,
        currency: "<%= begin project['default_currency']['code'] rescue 'GBP' end%>"
      }
    })
    .done(function(res){
      jq3('#totalPurchaseEquitiesValue').html(res.output);
    });
    jq3.post('/transaction-total', {
      data: {
        project: "<%= project['iati_identifier'] %>",
        transactionType: 6,
        currency: "<%= begin project['default_currency']['code'] rescue 'GBP' end%>"
      }
    })
    .done(function(res){
      jq3('#totalLoanRepaymentsValue').html(res.output);
    });
    jq3.post('/transaction-total', {
      data: {
        project: "<%= project['iati_identifier']%>",
        transactionType: 4,
        currency: "<%= begin project['default_currency']['code'] rescue 'GBP' end%>"
      }
    })
    .done(function(res){
      jq3('#totalExpenditureValue').html(res.output);
    });
    $('.transactions-tab').show();
  })
</script>