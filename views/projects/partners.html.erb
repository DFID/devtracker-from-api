<!-- title: Development Tracker -->

<%= erb :'partials/_projects-header', :locals => { :project => project, :countryOrRegion => countryOrRegion, :fundedProjectsCount => fundedProjectsCount, :fundingProjectsCount => fundingProjectsCount, :active => "partners"} %>

<div class="row">
    <div class="twelve columns">
        <% if(!is_dfid_project(project['iati_identifier'])) %>
        <div id="disclaimer" class="disclaimer grey">
            <div style="margin-top: 0px; padding: 0.3em 0.0em 0em;" class="ui-state-highlight ui-corner-all">
                <p style="margin-bottom: 0px; line-height: 1; font-size: 1em"><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span><strong>Disclaimer</strong>: The data for this page has been produced from IATI data published by <%= project['reporting_organisations'][0]['narratives'][0]['text'] || "" %>. Please contact them if you have any questions about their data.</p>
            </div>
        </div>
        <% end %>
    </div>
</div>

  <% if fundingProjectsCount > 0 then %>
      <div class="row">
          <div class="twelve columns results-info">
            <h3 class="section-group-title">Funding Project</h3>
            <% fundingProjects=fundingProjects.group_by{|b| b['provider_organisation']['provider_activity_id'].to_s.strip}.map{|provider_activity_id, budgets|
                    summedBudgets = budgets.reduce(0) {|memo, budget| memo + budget['value'].to_f}
                    [provider_activity_id, summedBudgets]} %>
            <% fundingProjects.each do |fundingProject| %>
                <% if is_valid_project(fundingProject[0]) %>
                  <% fundingProjectDetails= get_funding_project(fundingProject[0])%>
                  <% fundingProjectDetailsCurrency= get_funding_project(project['iati_identifier'])%>
                  <div class="row">        
                    <div class="four columns summary">
                        <h4><%= fundingProjectDetails['reporting_organisations'][0]['narratives'][0]['text'] %></h4>         
                    </div>
                    <div class="eight columns">
                        <ul>
                            <li><a href="/projects/<%=fundingProjectDetails['id']%>"><%=fundingProjectDetails['title']['narratives'][0]['text']%></a><%=fundingProjectDetails['descriptions'][0]['narratives'][0]['text']%><span><%= Money.new(fundingProject[1].to_f.round(0)*100, fundingProjectDetailsCurrency['default_currency']['code']).format(:no_cents_if_whole => true,:sign_before_symbol => false)%></span></li>
                        </ul> 
                    </div>
                  </div>
                <% end %>
            <% end %>
          </div>
      </div>
  <% end %>

  <% if fundedProjectsCount > 0 then %>
      <div class="row">
          <div class="twelve columns results-info">                 
              <% if is_dfid_project(project['id']) then %>
                <h3 class="section-group-title">Partner Projects</h3>
              <%else%>
                 <h3 class="section-group-title">Funded Projects</h3>
              <%end%>
                <% fundedProjects.each do |fundedProject| %>
                  <div class="row">
                      <div class="four columns summary">
                          <h4><%= if fundedProject['reporting_organisations'][0]['narratives'].length==0 then '' else fundedProject['reporting_organisations'][0]['narratives'][0]['text'] end %></h4>
                      </div>
                      <div class="eight columns">
                          <ul>
                             <%# TODO - deal with the situation where we have multiple languages %>
                             <li><a href="/projects/<%=fundedProject['id']%>"><%=fundedProject['title']['narratives'][0]['text']%></a>
                               <%=fundedProject['descriptions'][0]['narratives'][0]['text'] %>
                               <span><%= Money.new(fundedProject['aggregations']['activity_children']['incoming_funds_value'].to_f.round(0)*100,if fundedProject['aggregations']['activity_children']['incoming_funds_currency'].nil? then fundedProject['default_currency']['code'] else fundedProject['aggregations']['activity_children']['incoming_funds_currency'] end).format(:no_cents_if_whole => true,:sign_before_symbol => false) %></span>
                               <%#= get_implementing_orgs_as_label(fundedProject['id'])%>
                             </li>
                          </ul> 
                      </div>
                  </div>  
              <% end %>
          </div>
      </div>
  <% end %>